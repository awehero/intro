<!DOCTYPE html>
<html lang="en">
	<head>
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <title>Replay Viewer</title>
	    <link rel="icon" href="https://awehero.github.io/intro/awehero.png" type="image/png">
		<script src="https://cdn.babylonjs.com/babylon.js"></script>
	    <style>
	        body { font-family: Arial, sans-serif; margin: 20px; }
	        textarea { width: 100%; padding: 10px; font-family: monospace; }
	        body {
	            font-family: Arial, sans-serif;
	            margin: 20px;
	            line-height: 1.6;
	            background-color: #f9f9f9;
	            color: #333;
	        }
	        h1 {
	            font-size: 2em;
	            color: #007bff;
	            margin-bottom: 10px;
	        }
	        div {
	            font-size: 1.2em;
	        }
	        p {
	            margin-bottom: 10px;
	            font-size: 1em;
	        }
	        textarea {
	            width: 100%;
	            max-width: 600px;
	            padding: 10px;
	            font-family: monospace;
	            font-size: 1.7em;
	            border: 1px solid #ccc;
	            border-radius: 5px;
	            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
	        }
	        button {
	            padding: 10px 20px;
	            font-size: 1em;
	            background-color: #007bff;
	            color: white;
	            border: none;
	            border-radius: 5px;
	            cursor: pointer;
	            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
	        }
	        button:hover {
	            background-color: #0056b3;
	        }
	        #output {
	            background-color: #f4f4f4;
	            padding: 15px;
	            border-radius: 5px;
	            border: 1px solid #ddd;
	            font-family: monospace;
	            white-space: pre-wrap;
	            word-wrap: break-word;
	            overflow-x: auto;
	            max-width: 100%;
	            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
	        }
	        #copyButton {
	            margin-top: 10px;
	        }
	        .button-group {
	            display: flex;
	            gap: 10px;
	            margin: 10px 0;
	        }
			#suggestions {
				position: absolute;
			    max-height: 12em;
				width: 15em;
			    overflow: auto;
			    background-color: white;
			    border: 1px solid black;
				display: none;
				padding-left: 5px;
	    		padding-right: 5px;
			}
			.suggestion-item {
				font-size: 1em;
				cursor: pointer;
				border: 2px solid black;
			    border-radius: 5px;
			    padding-left: 5px;
				margin-bottom: 10px;
			}
			.suggestion-item:hover {
				background-color: #f0f0f0;
			}
			#replays {
			    max-height: 12em;
				width: 95%;
			    overflow: auto;
				display: none;
				padding-left: 5px;
	    		padding-right: 5px;
				columns: 10;
    			column-gap: 5px;
				margin-top: -25px;
				grid-template-columns: 9.5% 9.5% 9.5% 9.5% 9.5% 9.5% 9.5% 9.5% 9.5% 9.5%;
				overflow: clip;
			}
			.replay-item {
				font-size: 0.7em;
				cursor: pointer;
				border: 2px solid black;
			    border-radius: 5px;
			    padding-left: 5px;
				margin-bottom: 10px;
				width: 90%;
			}
			.replay-item:hover {
				background-color: #f0f0f0;
			}
			#canvas {
				width: 100%;
				height: 50%;
				touch-action: none;
				margin-top: 5%;
			}
			#slider {
				width: 75%;
			}
			#inputDisplay {
				position: absolute;
				bottom: 2%;
				left: 2%;
				width: 15%;
				height: 15%;
				border: 2px solid black;
				border-radius: 10px;
				display: flex;
				flex-direction: column;
				justify-content: space-between;
				align-items: center;
				backdrop-filter: blur(1px);
			}
			#inputDisplayTop, #inputDisplayBottom {
				width: 100%;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			#inputDisplayBottom {
				justify-content: space-around;
			}
			.inputDisplayButton {
				width: 40px;
				height: 40px;
				display: flex;
				justify-content: center;
				align-items: center;
				color: lightgray;
			}
			.inputDisplayButton svg {
				width: 100%;
				height: 100%;
			}
			#loading {
				display: none;
			    width: 70px;
			    image-rendering: pixelated;
			    position: absolute;
			}
			#useruuidContainer, #userUuid {
				display: none;
			}
			#fps {
				position: absolute;
				bottom: -2%;
				left: 7%;
				color: lightgray;
			}
			.bi-play-circle {
				height: 25px;
				width: 25px;
			}
	    </style>
	</head>
    <body>
        <h1>Replay Viewer</h1>
		<p>Start typing a map name or map id and select it from the dropdown</p>
        <input type="search" id="input"><br>
		<div id="suggestions"></div><br>
		
		<img id="loading" src="https://awehero.github.io/intro/gifs/loading.gif">
		<div id="useruuidContainer">
			<p>Select replays</p>
			<input id="userUuid"><br>
		</div>
		<div id="replays"></div><br>
	
        <!-- <button onclick="findReplay()">Go!</button> -->
		<br>
        <canvas id="canvas"></canvas>
		<button id="playpause" onclick="togglePlayPause()"></button>
		<input id="slider" type="range" name="slider" min="0" max="100" value="0">
		<span>
			<input id="speedslider" type="range" name="speedslider" min="0.1" max="5" value="1" step="0.1">
			<p id=speedDisplay>x1</p>
		</span>
		<button id="togglePlayer" onclick="togglePlayer()">Toggle Player</button>
		<div id="inputDisplay">
			<div id="inputDisplayTop">
				<div id="up" class="inputDisplayButton"></div>
			</div>
			<div id="inputDisplayBottom">
				<div id="left" class="inputDisplayButton"></div>
				<div id="down" class="inputDisplayButton"></div>
				<div id="right" class="inputDisplayButton"></div>
			</div>
		</div>
		<div id="fps">FPS:</div>
        <script>
			let input = document.getElementById("input");
			let userUuid = document.getElementById("userUuid");
			let useruuidContainer = document.getElementById("useruuidContainer");
			let suggestions = document.getElementById("suggestions");
			let loading = document.getElementById("loading");
			let replays = document.getElementById("replays");
			let playpause = document.getElementById("playpause");
			let slider = document.getElementById("slider");
			let speedslider = document.getElementById("speedslider");
			let speedDisplay = document.getElementById("speedDisplay");
			let toggleplayer = document.getElementById("togglePlayer");
			let up = document.getElementById("up");
			let down = document.getElementById("down");
			let left = document.getElementById("left");
			let right = document.getElementById("right");
			let fps = document.getElementById("fps");
			let replayData = "";
			let nodes = [];
			let nodesList = [];
			let state = "pause";
			let score = 0;
			let interval;
			let svgs = {};
			let svgUrls = {
				up: "https://awehero.github.io/intro/svgs/arrow-up-square.svg",
				down: "https://awehero.github.io/intro/svgs/arrow-down-square.svg",
				left: "https://awehero.github.io/intro/svgs/arrow-left-square.svg",
				right: "https://awehero.github.io/intro/svgs/arrow-right-square.svg",
				up_pressed: "https://awehero.github.io/intro/svgs/arrow-up-square-fill.svg",
				down_pressed: "https://awehero.github.io/intro/svgs/arrow-down-square-fill.svg",
				left_pressed: "https://awehero.github.io/intro/svgs/arrow-left-square-fill.svg",
				right_pressed: "https://awehero.github.io/intro/svgs/arrow-right-square-fill.svg",
				play: "https://awehero.github.io/intro/svgs/play-circle.svg",
				pause: "https://awehero.github.io/intro/svgs/pause-circle.svg",
			};
			Promise.all(Object.entries(svgUrls).map(async ([key, url]) => {
				const res = await fetch(url);
				svgs[key] = await res.text();
			}))
			.then(() => {
			  	console.log("All SVGs loaded!");
				up.innerHTML = svgs.up;
				down.innerHTML = svgs.down;
				left.innerHTML = svgs.left;
				right.innerHTML = svgs.right;
				playpause.innerHTML = svgs.play;
			});
			fetch('https://awehero.github.io/intro/minitools/mapdata.js')
				.then(response => response.text())
				.then(code => {
					eval(code);
					mapData = mapData.replace(/\;/g, "$").split("$");
					for (var i = 0; i < mapData.length; i++) {
					    mapData[i] = mapData[i].split("|");
					}
					input.addEventListener('input', function() {
						let text = input.value.toLowerCase();
						let maps = mapData.filter(function(map) {
						    return (map[1].indexOf(text.toLowerCase()) != -1) || (map[0].toLowerCase().indexOf(text.toLowerCase()) != -1)
						});
						if (maps.length > 0 && text.length != 0) {
							suggestions.innerHTML = '';
							maps.forEach(map=>{
								let suggestionItem = document.createElement("div");
								suggestionItem.classList.add("suggestion-item");
								suggestionItem.textContent = map[0];
								suggestionItem.id = map[1];
								suggestionItem.addEventListener("click", function() {
									input.value = this.id;
									getMap();
									getAllReplays();
									suggestions.style.display = "none";
								});
								suggestions.appendChild(suggestionItem);
							});
							suggestions.style.display = "block";
						} else {
							suggestions.style.display = "none";
						}
					});
				})
				.catch(err => console.error('Error loading script:', err));

			function getAllReplays() {
				fetch('https://icedodo-api.onionfist.com/api/get_replay_listings', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Accept': '*/*',
							'Accept-Encoding': 'gzip, deflate, br, zstd',
							'Accept-Language': 'en-US,en;q=0.9'
						},
						body: JSON.stringify({
							includeUid: "44f8f01d-048c-415e-9a56-bcfbeaefa076",
							mapId: input.value,
							ordering: 2
						})
					})
					.then(response => response.json())
					.then(data => {
						loading.style.display = "none"
						useruuidContainer.style.display = "block";
						replays.style.display = "grid";
						replayData = data.replayListings;
						if (replayData.length > 0) {
							replays.innerHTML = '';
							replayData.forEach(replay=>{
								let replayItem = document.createElement("div");
								replayItem.classList.add("replay-item");
								replayItem.innerHTML = `
									<span id=${replay.username}>
										${replay.username}
										<div value="âœ…">
									</span>`;
								replayItem.id = replay.userUuid;
								replayItem.addEventListener("click", function() {
									if (this.style.backgroundColor == "lightgreen") {
										this.style.backgroundColor = "";
										let index = nodesList.findIndex(rep => rep.userUuid == this.id);
										if (players[index] == activePlayer) {
											if (players.length == 1) {
												activePlayer = player;
												if (state == "play") {
													togglePlayPause();
												}
												score = 0;
												slider.value = 0;
											} else {
												togglePlayer();
											}
										}
										nodes.splice(index, 1);
										nodesList.splice(index, 1);
										scene.meshes[scene.meshes.indexOf(players[index])].dispose()
										players.splice(index, 1);
									} else {
										userUuid.value = this.id;
										this.style.backgroundColor = "lightgreen";
										useruuidContainer.style.display = "none";
										replays.style.display = "none";
										loading.style.display = "block";
										findReplay();
									}
								});
								replays.appendChild(replayItem);
							});
							replays.style.display = "grid";
						} else {
							replays.innerHTML = "No replays found!";
						}
					})
					.catch(error => console.error('Error:' + error));
			}
			
			function getMap() {
			    let map = input.value.trim();
				loading.style.display = "block";
			    fetch('https://icedodo.onionfist.com/maps/' + map + '.js')
			        .then(response => {
			            if (!response.ok) throw new Error('HTTP ' + response.status);
			            return response.text();
			        })
			        .then(code => {
			            mapfile = code;
						score = 0;
						if (state == "play") {
							togglePlayPause();
						}
						moveNodes();
						nodes = [];
						nodesList = [];
						players = [];
						loadMap();
			        })
			        .catch(error => console.error('Error: ' + error));
			}

			function findReplay() {
            	let map = input.value.trim();
				let userId = userUuid.value.trim();
            	fetch('https://icedodo-api.onionfist.com/api/get_replay_nodes', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Accept': '*/*',
						'Accept-Encoding': 'gzip, deflate, br, zstd',
						'Accept-Language': 'en-US,en;q=0.9'
					},
						body: JSON.stringify({
						userUuid: userId,
						mapId: map
					})
				})
				.then(response => response.json())
				.then(data => {
					useruuidContainer.style.display = "block";
					replays.style.display = "grid";
					loading.style.display = "none";
					nodes[nodes.length] = data.replayNodes;
					nodesList[nodesList.length] = replayData.find(rep=>rep.userUuid == userUuid.value);
					var playernext = BABYLON.MeshBuilder.CreateBox('player' + players.length, { width: 0.5, height: 0.08, depth: 0.5 }, scene);
					let skinUrl = skins[nodesList[players.length].skinId];
					let mat = new BABYLON.StandardMaterial("mat", scene);
					mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/intro/images/skins/"+skinUrl+".png", scene);
					playernext.material = mat;
					players.push(playernext);
					if (activePlayer == player) {
						activePlayer = playernext;
					}
					let sliderTemp = 0;
					for (var i = 0; i < nodesList.length; i++) {
					    if (nodesList[i].timeInFrames > sliderTemp) {
					        sliderTemp = nodesList[i].timeInFrames - 1;
					    }
					}
					slider.max = sliderTemp;
					for (var i = 0; i < nodes.length; i++) {
						while (nodes[i].length < sliderTemp + 1) {
							nodes[i][nodes[i].length] = nodes[i][nodes[i].length - 1]
						}
					}
				})
				.catch(error => console.error('Error:' + error));
        	}
			
			slider.addEventListener('input', () => {
		    	score = parseFloat(slider.value);
				moveNodes();
		    });
			speedslider.addEventListener("input", () => {
				startLoop();
				speedDisplay.innerText = "x" + speedslider.value;
			});
			
			function togglePlayPause() {
				if (state == "pause") {
					if (players.length == 0) {
						alert("You must select at least one replay!");
					} else {
						state = "play";
						playpause.innerHTML = svgs.pause;
					}
				} else {
					state = "pause";
					playpause.innerHTML = svgs.play;
				}
			}

			function startLoop() {
			    clearInterval(interval);
			    interval = setInterval(function() {
			        if (state === "play") {
			            if (score <= slider.max) {
			                moveNodes();
			                score++;
			            }
			        }
			    }, (1000 / 60) / Number(speedslider.value));
			}
			startLoop();

			function moveNodes() {
				for (var i = 0; i < nodes.length; i++) {
					slider.value = score;
					players[i].position.x = nodes[i][score].px;
					players[i].position.y = nodes[i][score].py;
					players[i].position.z = nodes[i][score].pz;
					let angles = new BABYLON.Quaternion(nodes[i][score].rx,nodes[i][score].ry,nodes[i][score].rz,nodes[i][score].rw).toEulerAngles();
					players[i].rotation.x = angles.x;
					players[i].rotation.y = angles.y;
					players[i].rotation.z = angles.z;
					players[i].scaling.x = nodes[i][score].sx;
					players[i].scaling.y = nodes[i][score].sy;
					players[i].scaling.z = nodes[i][score].sz;
					if (activeCamera == followCamera) {
						let playerIndex = players.indexOf(activePlayer);
						rotation = nodes[playerIndex][score].r;
						updateInputDisplay(playerIndex);
						fps.innerText = `FPS: ${Math.round(nodes[playerIndex][score].fps)}`
					}
					
				}
			}
			function updateInputDisplay(p) {
				if (nodes[p][score].w) {
					up.innerHTML = svgs.up_pressed;
				} else {
					up.innerHTML = svgs.up;
				}
				if (nodes[p][score].s) {
					down.innerHTML = svgs.down_pressed;
				} else {
					down.innerHTML = svgs.down;
				}
				if (nodes[p][score].a) {
					left.innerHTML = svgs.left_pressed;
				} else {
					left.innerHTML = svgs.left;
				}
				if (nodes[p][score].d) {
					right.innerHTML = svgs.right_pressed;
				} else {
					right.innerHTML = svgs.right;
				}
			}





			// Scene
			let objects = "";
			let planes = [];
			let platforms = [];
			let cones = [];
			let endings = [];
			let cylinders = [];
			let spheres = [];
			let monkeys = [];
			let mapfile = "";
			let players = [];
			let defaultbg = "";
			let planezs = [];
			let skins = ["default","pilot","carrot","rocky","dodo","skilled","furby","doom","kazil","zhou","ye","tim","ghoul","abc","rytai","moosh","dark","awehero","jay","golden","bean","fish","thero","crazy","june","sleepy","mango","insolence","squirrel","painbumpo","modded","collab","og","ultrahard","diff1","diff2","diff3","diff4","diff5","diff6","diff7","diff8","diff9","diff10","diff11","pointsa","pointsb","pointsc","pointsd","pointse","pointsf","pointsg","percenta","percentb","percentc","percentd","percente","puzzlea","puzzleb"];
			var canvas = document.getElementById("canvas");
            var engine = new BABYLON.Engine(canvas, true);
			var scene = new BABYLON.Scene(engine);
			function am(id) {
			    return scene.getMeshById(id);
			}
			var followCamera = new BABYLON.UniversalCamera("followCamera", new BABYLON.Vector3(0, 5, -10), scene);
			followCamera.fov = 1.2;
			let activeCamera = followCamera;
			var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
			light.specular = new BABYLON.Color3(0.95, 0.95, 0.81);
			light.parent = activeCamera;
			window.rotation = 0;
			window.radius = 2.5;
		    window.cameraRightAngle = 0;
		    window.cam_horizontal = radius * radius;
		    window.cam_vertical = cam_horizontal * Math.tan(radius * 1.3);
		    window.cam_depression = 0.3;
			var player = BABYLON.MeshBuilder.CreateBox('player', { width: 0.5, height: 0.08, depth: 0.5 }, scene);
			player.isVisible = false;
			var activePlayer = player;
			function updateFollowCamera() {
		    	const rotation_offsetted = window.rotation + window.cameraRightAngle;
		        followCamera.position.x = activePlayer.position.x + Math.sin(rotation_offsetted) * window.cam_horizontal;
		        followCamera.position.z = activePlayer.position.z + Math.cos(rotation_offsetted) * window.cam_horizontal;
		        followCamera.position.y = activePlayer.position.y + window.cam_vertical +2; //Fix later
		        followCamera.rotation.y = Math.PI + rotation_offsetted;
		        followCamera.rotation.x = window.cam_depression;
				followCamera.setTarget(activePlayer.position);
		    }
			function togglePlayer() {
				let next = players.indexOf(activePlayer) + 1;
				if (next > players.length - 1) next = 0;
				activePlayer = players[next];
			}
			var freeCamera = new BABYLON.UniversalCamera("freeCamera", new BABYLON.Vector3(0, 5, -10), scene);
			freeCamera.rotation = new BABYLON.Vector3(0, Math.PI, 0);
			freeCamera.position = followCamera.position;
		
			let keys = {};
			window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
			window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);
		
			function updateFreeCamera() {
				const cameraSpeed = 0.5;
				const rotSpeed = 0.01;
				if (keys["w"]) { freeCamera.position.x += Math.sin(freeCamera.rotation.y) * cameraSpeed; freeCamera.position.z += Math.cos(freeCamera.rotation.y) * cameraSpeed; }
				if (keys["s"]) { freeCamera.position.x -= Math.sin(freeCamera.rotation.y) * cameraSpeed; freeCamera.position.z -= Math.cos(freeCamera.rotation.y) * cameraSpeed; }
				if (keys["a"]) { freeCamera.position.x += Math.sin(freeCamera.rotation.y - Math.PI / 2) * cameraSpeed; freeCamera.position.z += Math.cos(freeCamera.rotation.y - Math.PI / 2) * cameraSpeed; }
				if (keys["d"]) { freeCamera.position.x += Math.sin(freeCamera.rotation.y + Math.PI / 2) * cameraSpeed; freeCamera.position.z += Math.cos(freeCamera.rotation.y + Math.PI / 2) * cameraSpeed; }
				if (keys["e"]) freeCamera.position.y += cameraSpeed;
				if (keys["c"]) freeCamera.position.y -= cameraSpeed;
				if (keys["arrowup"]) freeCamera.rotation.x -= rotSpeed;
				if (keys["arrowdown"]) freeCamera.rotation.x += rotSpeed;
			}
		
			scene.activeCamera = activeCamera;
			scene.activeCamera.attachControl(canvas, true);
		
			window.addEventListener("keydown", e => {
				if (e.key === "Tab") {
					e.preventDefault();
					activeCamera.detachControl();
					if (activeCamera === followCamera) {
						activeCamera = freeCamera;
						inputDisplay.style.display = "none";
						fps.style.display = "none";
					} else {
						activeCamera = followCamera;
						inputDisplay.style.display = "flex";
						inputDisplay.style.display = "block";
						fps.style.display = "block";
					}
					scene.activeCamera = activeCamera;
					activeCamera.attachControl(canvas, true);
				}
			});
			engine.runRenderLoop(() => {
		        if (activeCamera === followCamera) updateFollowCamera();
		        if (activeCamera === freeCamera) updateFreeCamera();
		        scene.render();
		    });
			window.addEventListener("resize", () => engine.resize());
			
			function loadMap() {
				let removers = ['P','C','E','Y','S'];
				for (var i = scene.meshes.length-1; i > -1; i--) {
					if (removers.includes(scene.meshes[i].id.substring(0,1))) {
						scene.meshes[i].dispose();
					}
				}
				planes = [];
				platforms = [];
				cones = [];
				endings = [];
				cylinders = [];
				spheres = [];
				monkeys = [];
				followCamera.position = new BABYLON.Vector3(0, 5, -10);
				freeCamera.rotation = new BABYLON.Vector3(0, Math.PI, 0);
				freeCamera.position = followCamera.position;
				if (activeCamera == freeCamera) {
					activeCamera = followCamera;
					inputDisplay.style.display = "flex";
					inputDisplay.style.display = "block";
					fps.style.display = "block";
				}
				let postOne = '';
				if (mapfile.indexOf("section_id: 0") == -1) {
					postOne = mapfile.substring(mapfile.indexOf("post"),mapfile.indexOf("section_id:0"));
				} else {
					postOne = mapfile.substring(mapfile.indexOf("post"),mapfile.indexOf("section_id: 0"));
				}
				let post = postOne.substring(postOne.indexOf("cc"));
				post = post.replace(/\s+/g, "")
							.replace(/"/g, "")
							.replace(/cc\.set_monkey\(/g, "")
							.replace(/speed,0.2\);/g, "")
							.replace(/steer,0.03\);/g, "")
							.replace(/\)/g, "")
							.replace(/jumpSpeed/g, "js")
							.replace(/jumpHeight/g, "jh")
							.replace(/steer,default_steer\*/g, "turn,")
							.replace(/speed,default_speed\*/g, "speed,")
							.replace(/radius/g, "d")
							.replace(/camera\.maxZ/g, "eye")
							.replace(/camera\.fovmul2/g, "fov")
							.replace(/cameraDownAngle/g, "cd")
							.replace(/cameraRightAngle/g, "cr")
							.replace(/\*Math\.PI\/180/g, "")
							.replace(/light\.intensity/g, "br")
							.replace(/scene\.clearColor,newBABYLON\.Color3\.FromHexString\(#/g, "bg,")
							.replace(/scene\.ambientColor,newBABYLON\.Color3\.FromHexString\(#/g, "amb,")
							.replace(/light\.groundColor,newBABYLON\.Color3\.FromHexString\(#/g, "gro,")
							.replace(/light\.diffuse,newBABYLON\.Color3\.FromHexString\(#/g, "dif,")
							.replace(/light\.specular,newBABYLON\.Color3\.FromHexString\(#/g, "spe,")
							.replace(/gravity,newBABYLON\.Vector3\(/g, "gravity,")
							.replace(/camera\.upVector,newBABYLON\.Vector3\(/g, "tilt,")
							.replace(/player\.scaling,newBABYLON\.Vector3\(/g, "dodoScale,")
							.replace(/isSpinLocked,true/, "sl,on")
							.replace(/isSpinLocked,false/, "sl,off")
							.replace(/cc.refresh\(;/g, "")
				post = post.substring(0,post.length-3);
				post = post.split(";");
				for (var i=0; i < post.length; i++) {
					if (post[i].length <= 10) {
						post[i] = post[i].replace(/,/g, "=");
					} else if (post[i].substring(0,4) == "grav") {
						let gravHelp = "";
						if (post[i].split(",")[1] != "null") {
								gravHelp = "gx=" + post[i].split(",")[1]/-9;
						}
						if (post[i].split(",")[2] != "null") {
							if (gravHelp == "") {
								gravHelp = "gy=" + post[i].split(",")[2]/-9;
							} else {
								gravHelp = gravHelp + "?gy=" + post[i].split(",")[2]/-9
							}
						}
						if (post[i].split(",")[3] != "null") {
							if (gravHelp == "") {
								gravHelp = "gz=" + post[i].split(",")[3]/-9;
							} else {
								gravHelp = gravHelp + "?gz=" + post[i].split(",")[3]/-9
							}
						}
						post[i] = gravHelp;
					} else if (post[i].substring(0,4) == "tilt") {
						let tiltHelp = "";
						if (post[i].split(",")[1] != "null") {
								tiltHelp = "tx=" + post[i].split(",")[1];
						}
						if (post[i].split(",")[2] != "null") {
							if (tiltHelp == "") {
								tiltHelp = "ty=" + post[i].split(",")[2];
							} else {
								tiltHelp = tiltHelp + "?ty=" + post[i].split(",")[2]
							}
						}
						if (post[i].split(",")[3] != "null") {
							if (tiltHelp == "") {
								tiltHelp = "tz=" + post[i].split(",")[3];
							} else {
								tiltHelp = tiltHelp + "?tz=" + post[i].split(",")[3]
							}
						}
						post[i] = tiltHelp;
					} else if (post[i].substring(0,4) == "dodo") {
						let dodoHelp = "";
						if (post[i].split(",")[1] != "null") {
								dodoHelp = "dx=" + post[i].split(",")[1];
						}
						if (post[i].split(",")[2] != "null") {
							if (dodoHelp == "") {
								dodoHelp = "dy=" + post[i].split(",")[2];
							} else {
								dodoHelp = dodoHelp + "?dy=" + post[i].split(",")[2]
							}
						}
						if (post[i].split(",")[3] != "null") {
							if (dodoHelp == "") {
								dodoHelp = "dz=" + post[i].split(",")[3];
							} else {
								dodoHelp = dodoHelp + "?dz=" + post[i].split(",")[3]
							}
						}
						post[i] = dodoHelp;
					}
				}
				let name = "";
				for (var i = 0; i < post.length; i++) {
					if (i != post.length - 1) {
						name = name + post[i] + "?";
					} else {
						name = name + post[i];
					}
				}
				if (name.length != 0) {
					let monkeyTemp = [];
					monkeyTemp.push(0);
					monkeyTemp.push(1500);
					monkeyTemp.push(1500);
					monkeyTemp.push(0);
					monkeyTemp.push(0);
					monkeyTemp.push(0);
					monkeyTemp.push(50);
					monkeyTemp.push(50);
					monkeyTemp.push(50);
					monkeyTemp.push(name);
					monkeys.push(monkeyTemp);
				}
				if (monkeys.length > 0) {
					let mVars = monkeys[0][9].split("?");
					for (var i = 0; i < mVars.length; i++) {
					    if (mVars[i].substring(0,3) == "bg=") {
							defaultbg = new BABYLON.Color3.FromHexString("#"+mVars[i].substring(3,9));
					        scene.clearColor = defaultbg;
					    }
					}
				} else {
					defaultbg = new BABYLON.Color3.FromHexString("#000000");
					scene.clearColor = defaultbg;
				}
				let section = "";
				if (mapfile.indexOf("reset: function") == -1) {
				    section = mapfile.substring(mapfile.indexOf("section_update:"),mapfile.indexOf("reset:function"));
				} else {
				    section = mapfile.substring(mapfile.indexOf("section_update:"),mapfile.indexOf("reset: function"));
				}
				function replaceMsgWithASCII(inputASCII) {
				    return inputASCII.replace(/a\.msg_set\("([^"]*)"\);/g, (match, p1) => {
				        const asciiValues = Array.from(p1).map(char => char.charCodeAt(0));
				        const asciiString = asciiValues.join('?');
				        return `msg=${asciiString};`;
				    });
				}
				section = replaceMsgWithASCII(section);
				let sectionTwo = section.replace(/\s+/g, "")
				                .replace(/\"/g, "")
				                .replace(/\'/g, "")
				                .replace(/section_update:function\(\){/g, "")
				                .replace(/letPZ=player\.position\.z;switch\(this\.section_id\){/g, "")
				                .replace(/if\(PZ</g, "")
				                .replace(/this\.section_id\+=1}break;/g, "")
				                .replace(/case/g, "")
				                .replace(/default_speed\*/g, "")
				                .replace(/default_steer\*/g, "")
				                .replace(/speed=cc.get\(speed\,null\);/g, "")
				                .replace(/steer=cc.get\(steer\,null\);/g, "")
				                .replace(/camera.maxZ=cc.get\(camera.maxZ\,null\);/g, "")
				                .replace(/light.intensity=cc.get\(light.intensity\,null\);/g, "")
				                .replace(/spinlock=cc.get\(isSpinLocked\,null\);/g, "")
				                .replace(/scene.clearColor=cc.get\(scene.clearColor\,null\);/g, "")
				                .replace(/scene.ambientColor=cc.get\(scene.ambientColor\,null\);/g, "")
				                .replace(/light.diffuse=cc.get\(light.diffuse\,null\);/g, "")
				                .replace(/light.specular=cc.get\(light.specular\,null\);/g, "")
				                .replace(/light.groundColor=cc.get\(light.groundColor\,null\);/g, "")
				                .replace(/newBABYLON.Color3.FromHexString\(\#/g, "")
				                .replace(/a.jh\(null\);/g, "")
				                .replace(/a.js\(null\);/g, "")
				                .replace(/a.g\(null,null,null\);/g, "")
				                .replace(/a.t\(null,null,null\);/g, "")
				                .replace(/a.d\(null,null,null\);/g, "")
				                .replace(/a.cam_cd\(null\);/g, "")
				                .replace(/a.cam_cr\(null\);/g, "")
				                .replace(/a.cam_d\(null\);/g, "")
				                .replace(/a.fov_mul2\(\);/g, "")
				                .replace(/a.msg_del\(\);/g, "")
				                .replace(/\*Math.PI\/180/g, "");
				let sectionThree = sectionTwo.split(":");
				let sectionFour = [];
				for (var i = 1; i < sectionThree.length; i++) {
				        sectionFour.push(sectionThree[i].substring(0,sectionThree[i].length - (i.toString().length)));
				}
				for (var i = 0; i < sectionFour.length; i++) {
				    sectionFour[i] = sectionFour[i].replace(/}/g, "");
				    if (sectionFour[i].substring(sectionFour[i].length - 1) == ';') {
				        sectionFour[i] = sectionFour[i].substring(0,sectionFour[i].length - 1);
				    } else if (sectionFour[i].substring(sectionFour[i].length - 2) == '\)\{') {
				        sectionFour[i] = sectionFour[i].substring(0,sectionFour[i].length - 2);
				    }
				    sectionFour[i] = sectionFour[i].split(/;|\)\{/);
				}
				let sectionFive = [];
				for (var i = 0; i < sectionFour.length; i++) {
				    sectionFive[i] = [];
				    let numSpot = 0;
				    for (var j = 0; j < sectionFour[i].length; j++) {
				        if (sectionFour[i][j] * 0 == 0) {
				            numSpot = j;
				        }
				    }
				    for (var j = 0; j < sectionFour[i].length; j++) {
				        if (j < numSpot) {
				            sectionFive[i-1].push(sectionFour[i][j]);
				        } else {
				            sectionFive[i].push(sectionFour[i][j]);
				        }
				    }
				}
				for (var i = 0; i < sectionFive.length; i+=2) {
				    planezs.push([sectionFive[i][0], sectionFive[i+1][0]]);
				}
				for (var i = 0; i < sectionFive.length / 2; i++) {
				    let planeArray = [];
				    planeArray.push(0);
				    planeArray.push(0);
				    planeArray.push(-2100);
				    planeArray.push(0);
				    planeArray.push(0);
				    planeArray.push(0);
				    planeArray.push(100000);
				    planeArray.push(0);
				    planeArray.push(100);
				    planeArray.push("");
				    planes.push(planeArray);
				}
				if (Math.round(sectionFive.length / 2) != sectionFive.length / 2) {
				    alert("Invalid number of planes! Please send Awehero the data and ask him to fix the plane count!");
				}
				let red = '';
				let orange = '';
				for (var i = 0; i < sectionFive.length; i+=2) {
				    red = Math.round(parseFloat(sectionFive[i][0]) * 10000) / 10000;
				    orange = Math.round(parseFloat(sectionFive[i+1][0]) * 10000) / 10000;
				    planes[i/2][1] = Math.round((((red - orange) / 2) + orange) * 100000) / 1000;
				    planes[i/2][7] = Math.round(((red - orange) / 0.02) * 10000) / 10000;
				}
				mapfile = mapfile.replace(/\s+/g,"");
				objects = mapfile.substring(mapfile.indexOf("init:"),mapfile.indexOf("post:"));
				objects = objects.substring(objects.indexOf("{")+1,objects.indexOf("}"));
				objects = objects.split(";");
				for (var i = 0; i < objects.length; i++) {
					let type = objects[i].substring(0,3);
					objects[i] = objects[i].substring(4,objects[i].length-1);
					objects[i] = objects[i].replace(/\[/g,"").replace(/\]/g,"");
					if (objects[i].indexOf("\"") != -1) {
						objects[i] = objects[i].substring(0,objects[i].indexOf("\"")) + objects[i].substring(objects[i].indexOf("\""),objects[i].lastIndexOf("\"")).replace(/\,/g,"?") + objects[i].substring(objects[i].lastIndexOf("\""),objects[i].length);
					}
					objects[i] = objects[i].replace(/\"/g,"");
					objects[i] = objects[i].split(",");
					for (var j = 0; j < objects[i].length-1; j++) {
						if (objects[i][j] == parseFloat(objects[i][j])) {
							objects[i][j] = parseFloat(objects[i][j]);
						}
					}
					let obj = createMesh(type, objects, i);
					if (obj) scene.addMesh(obj);
				}
			}
			
			function createMesh(type, objects, i) {
				 switch (type) {
					 case 'a.p':
						 return createObject("P",objects[i][0],objects[i][1],objects[i][2],objects[i][3],objects[i][4],objects[i][5],objects[i][6],objects[i][7],objects[i][8],objects[i][9]);
					 case 'a.c':
						 return createObject("C",objects[i][0],objects[i][1],objects[i][2],objects[i][3]);
					 case 'a.e':
						 return createObject("E",objects[i][0],objects[i][1],objects[i][2]);
					 case 'a.y':
						 return createObject("Y",objects[i][0],objects[i][1],objects[i][2],objects[i][3],objects[i][4],objects[i][5],objects[i][6],objects[i][7],objects[i][8],objects[i][9]);
					 case 'a.s':
						 return createObject("S",objects[i][0],objects[i][1],objects[i][2],objects[i][3],objects[i][4]);
				 }
			 }
			
			function createObject(shape,zero,one,two,three,four,five,six,seven,eight,nine) {
				let obj;
				let mat = new BABYLON.StandardMaterial("mat", scene);
				switch (shape) {
					case "P":
				        obj = BABYLON.MeshBuilder.CreateBox("P"+platforms.length, { size: 1 }, scene);
						if (typeof nine == 'undefined') {
							mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/intro/images/textures/main.png", scene);
						} else if (nine.length == 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+nine);
						} else if (nine.length > 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+nine.substring(0,6));
							mat.alpha = parseFloat(nine.substring(7));
						} else {
							switch (String(nine)) {
								case "-1": mat.alpha = 0; break;
								case "0": mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/intro/images/textures/main.png", scene); break;
								case "0a": mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/intro/images/textures/main.png", scene); break;
								case "0b": mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/intro/images/textures/bright.png", scene); break;
								case "1": mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/intro/images/textures/pm1.png", scene); break;
								case "2": mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/intro/images/textures/pm2.png", scene); break;
								case "3":
									mat.diffuseColor = new BABYLON.Color3(0, 0, 1);
									mat.alpha = 0.55;
									break;
								case "4":
									mat.diffuseColor = new BABYLON.Color3(1, 1, 1);
									mat.alpha = 1.0;
									break;
								case "5":
									mat.diffuseColor = new BABYLON.Color3(1, 0, 0);
									mat.alpha = 1.0;
									break;
								case "6":
									mat.diffuseColor = new BABYLON.Color3(34/255, 139/255, 34/255);
									mat.alpha = 0.4;
									break;
								case "7":
									mat.diffuseColor = new BABYLON.Color3(165/255, 42/255, 42/255);
									mat.alpha = 0.8;
									break;
								case "8":
									mat.diffuseColor = new BABYLON.Color3(64/255, 164/255, 223/255);
									mat.alpha = 0.2;
									break;
								case "9":
									mat.diffuseColor = new BABYLON.Color3(0/255, 0/255, 0/255);
									mat.alpha = 1.0;
									break;
							}
						}
						obj.material = mat;
						obj.position = new BABYLON.Vector3(zero, one, two);
						obj.rotation = new BABYLON.Vector3(four, three, five);
						obj.scaling = new BABYLON.Vector3(six, seven, eight);
						platforms.push(obj);
						break;
				    case "C":
				        obj = BABYLON.MeshBuilder.CreateCylinder("C"+cones.length, { height: 0.5, diameterTop: 0, diameterBottom: 0.5, tessellation: 5 }, scene);
						obj.position = new BABYLON.Vector3(zero, one, two);
						obj.scaling.y = 1.2;
						cones.push(obj);
						if (typeof three == 'undefined') {
							mat.diffuseColor = new BABYLON.Color3(235/255, 50/255, 50/255);
						} else if (three.length == 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+three);
						} else if (three.length > 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+three.substring(0,6));
							mat.alpha = parseFloat(three.substring(7));
						} else {
							switch (String(three)) {
								case "-1": mat.alpha = 0; break;
								case "0":
									mat.diffuseColor = new BABYLON.Color3(235/255, 50/255, 50/255);
									mat.alpha = 1.0;
									break;
								case "1":
									mat.diffuseColor = new BABYLON.Color3(65/255, 174/255, 217/255);
									mat.alpha = 1.0;
									break;
							}
						}
						obj.material = mat;
						break;
				    case "E":
				        obj = BABYLON.MeshBuilder.CreateCylinder("E"+endings.length, { height: 2.0, diameter: 2.0, tessellation: 16 }, scene);
						mat.diffuseColor = new BABYLON.Color3(36/255, 252/255, 3/255);
						mat.alpha = 0.5;
						obj.material = mat;
						obj.position = new BABYLON.Vector3(zero, one, two);
						endings.push(obj);
						break;
				    case "Y":
				        obj = BABYLON.MeshBuilder.CreateCylinder("Y"+cylinders.length, { height: 1.0, diameter: 1.0, tessellation: 12 }, scene);
						if (typeof nine == 'undefined') {
							mat.diffuseColor = new BABYLON.Color3(1, 1, 1);
							mat.alpha = 1;
						} else if (nine.length == 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+nine);
						} else if (nine.length > 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+nine.substring(0,6));
							mat.alpha = parseFloat(nine.substring(7));
						} else {
							switch (String(nine)) {
								case "-1": mat.alpha = 0; break;
								case "0":
									mat.diffuseColor = new BABYLON.Color3(1, 1, 1);
									mat.alpha = 1.0;
									break;
								case "1":
									mat.diffuseColor = new BABYLON.Color3(242/255, 22/255, 103/255);
									mat.alpha = 1.0;
									break;
								case "2":
									mat.diffuseColor = new BABYLON.Color3(146/255, 95/255, 217/255);
									mat.alpha = 1.0;
									break;
								case "3":
									mat.diffuseColor = new BABYLON.Color3(0/255, 0/255, 255/255);
									mat.alpha = 0.55;
									break;
								case "4":
									mat.diffuseColor = new BABYLON.Color3(255/255, 0/255, 0/255);
									mat.alpha = 1.0;
									break;
								case "5":
									mat.diffuseColor = new BABYLON.Color3(34/255, 139/255, 34/255);
									mat.alpha = 0.4;
									break;
								case "6":
									mat.diffuseColor = new BABYLON.Color3(165/255, 42/255, 42/255);
									mat.alpha = 0.8;
									break;
								case "7":
									mat.diffuseColor = new BABYLON.Color3(64/255, 164/255, 223/255);
									mat.alpha = 0.2;
									break;
							}
						}
						obj.material = mat;
						obj.position = new BABYLON.Vector3(zero, one, two);
						obj.rotation = new BABYLON.Vector3(four, three, five);
						obj.scaling = new BABYLON.Vector3(six, seven, eight);
						cylinders.push(obj);
						break;
					case "S":
						obj = BABYLON.MeshBuilder.CreateSphere("S"+spheres.length, { segments: 10, diameter: 1.0 }, scene);
						if (typeof four == 'undefined') {
							mat.diffuseColor = new BABYLON.Color3(40/255, 60/255, 235/255);
							mat.alpha = 0.8;
						} else if (four.length == 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+four);
						} else if (four.length > 6) {
							mat.diffuseColor = new BABYLON.Color3.FromHexString("#"+four.substring(0,6));
							mat.alpha = parseFloat(four.substring(7));
						} else {
							switch (String(four)) {
								case "-1": mat.alpha = 0; break;
								case "0":
									mat.diffuseColor = new BABYLON.Color3(40/255, 60/255, 235/255);
									mat.alpha = 0.8;
									break;
								case "1":
									mat.diffuseColor = new BABYLON.Color3(242/255, 22/255, 103/255);
									mat.alpha = 1.0;
									break;
								case "2":
									mat.diffuseColor = new BABYLON.Color3(146/255, 95/255, 217/255);
									mat.alpha = 1.0;
									break;
								case "3":
									mat.diffuseColor = new BABYLON.Color3(0/255, 0/255, 255/255);
									mat.alpha = 0.4;
									break;
								case "4":
									mat.diffuseColor = new BABYLON.Color3(255/255, 255/255, 255/255);
									mat.alpha = 1.0;
									break;
							}
						}
						obj.material = mat;
						obj.position = new BABYLON.Vector3(zero, one, two);
						obj.scaling = new BABYLON.Vector3(three, three, three);
						spheres.push(obj);
						break;
				}
				return obj;
			}
        </script>
    </body>
</html>
